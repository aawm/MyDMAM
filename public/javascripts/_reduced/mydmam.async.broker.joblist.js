(function(a){a.Jobs=React.createClass({displayName:"Jobs",getInitialState:function(){return{selected_tab:0,joblist:{},since:0,last_full_refresh:0,interval:null};
},onTabChange:function(c,b){this.setState({selected_tab:c});},onActionTabClick:function(d,b){var c={all_status:b,order:d};
document.body.style.cursor="wait";mydmam.async.request("broker","action",c,this.onActionAlterJoblist);
},onActionButtonClick:function(d,c){var b={job_key:d.key,order:c};document.body.style.cursor="wait";
mydmam.async.request("broker","action",b,this.onActionAlterJoblist);},onActionAlterJoblist:function(b){var d=jQuery.extend({},this.state.joblist);
for(var c in b){if(b[c]==null){delete d[c];}else{d[c]=b[c];}}this.setState({joblist:d});
document.body.style.cursor="default";},componentWillMount:function(){this.updateJobList();
},componentDidMount:function(){this.setState({interval:setInterval(this.updateJobList,3000)});
},componentWillUnmount:function(){if(this.state.interval){clearInterval(this.state.interval);
}},updateJobList:function(){var b=this.state.since;if(Date.now()-this.state.last_full_refresh>(5*60*1000)){b=0;
}mydmam.async.request("broker","list",{since:b},function(c){if(b==0){this.setState({joblist:c,since:Date.now(),last_full_refresh:Date.now()});
}else{if(Object.keys(c).length==0){return;}this.setState({joblist:jQuery.extend({},this.state.joblist,c),since:Date.now()});
}}.bind(this));},render:function(){var b=mydmam.async.isAvaliable("broker","action");
return(React.createElement(mydmam.async.PageHeaderTitle,{title:i18n("manager.jobs.joblist"),fluid:"true"},React.createElement(a.NavTabs,{selected_tab:this.state.selected_tab,onActionTabClick:this.onActionTabClick,onTabChange:this.onTabChange,joblist:this.state.joblist,action_avaliable:b}),React.createElement(a.JobListCartridges,{joblist:this.state.joblist,selected_tab:this.state.selected_tab,onActionButtonClick:this.onActionButtonClick,action_avaliable:b})));
}});mydmam.routes.push("broker-Jobs","broker",a.Jobs,[{name:"broker",verb:"list"}]);
a.status={WAITING:{tab:0,i18n_tab_name:"manager.jobs.status.WAITING",badge_class:null,btns:["hipriority","cancel","postponed","noexpiration","delete"]},PREPARING:{tab:1,i18n_tab_name:"manager.jobs.status.PREPARING",badge_class:"badge-warning",btns:[]},PROCESSING:{tab:2,i18n_tab_name:"manager.jobs.status.PROCESSING",badge_class:"badge-warning",btns:["stop"]},DONE:{tab:3,i18n_tab_name:"manager.jobs.status.DONE",badge_class:"badge-success",btns:["setinwait","postponed","noexpiration","delete"]},ERROR:{tab:4,i18n_tab_name:"manager.jobs.status.ERROR",badge_class:"badge-important",btns:["cancel","setinwait","postponed","noexpiration","delete"]},TOO_OLD:{tab:5,i18n_tab_name:"manager.jobs.status.TOO_OLD",badge_class:"badge-info",btns:["cancel","setinwait","postponed","noexpiration","delete"]},TOO_LONG_DURATION:{tab:6,i18n_tab_name:"manager.jobs.status.TOO_LONG_DURATION",badge_class:"badge-info",btns:["cancel","setinwait","postponed","noexpiration","delete"]},STOPPED:{tab:7,i18n_tab_name:"manager.jobs.status.STOPPED",badge_class:"badge-important",btns:["cancel","setinwait","postponed","noexpiration","delete"]},CANCELED:{tab:8,i18n_tab_name:"manager.jobs.status.CANCELED",badge_class:null,btns:["setinwait","postponed","noexpiration","delete"]},POSTPONED:{tab:9,i18n_tab_name:"manager.jobs.status.POSTPONED",badge_class:null,btns:["setinwait","noexpiration","delete"]}};
a.NavTabs=React.createClass({displayName:"NavTabs",getInitialState:function(){return{display_drop_down_action:false};
},componentWillReceiveProps:function(b){if(this.props.action_avaliable==false){return;
}this.updateDisplayDropDownAction(b);},updateDisplayDropDownAction:function(c){if(this.props.action_avaliable==false){return;
}for(var b in c.joblist){var d=c.joblist[b];if(a.status[d.status].tab==c.selected_tab){this.setState({display_drop_down_action:true});
return;}}this.setState({display_drop_down_action:false});},componentWillMount:function(){if(this.props.action_avaliable==false){return;
}this.updateDisplayDropDownAction(this.props);},render:function(){var h={0:0,1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0};
for(var d in this.props.joblist){var g=this.props.joblist[d];h[a.status[g.status].tab]++;
}var e=[];for(var c in a.status){var b=a.status[c];e.push(React.createElement(a.Tab,{i18n_tab_name:b.i18n_tab_name,tab_index:b.tab,selected_tab:this.props.selected_tab,badge_class:b.badge_class,onTabChange:this.props.onTabChange,tabs_count:h,key:c}));
}if(this.state.display_drop_down_action&this.props.action_avaliable){var f=null;for(var c in a.status){if(this.props.selected_tab==a.status[c].tab){f=c;
break;}}e.push(React.createElement(a.NavTabDropDownAction,{key:"action",selected_status_tab:f,onActionTabClick:this.props.onActionTabClick}));
}return(React.createElement("ul",{className:"nav nav-tabs"},e));}});a.Tab=React.createClass({displayName:"Tab",onClick:function(b){b.preventDefault();
$(React.findDOMNode(this.refs.tab)).blur();this.props.onTabChange(this.props.tab_index);
},render:function(){var d=null;var b=this.props.tabs_count[this.props.tab_index];
if(b>0){var e=classNames("badge",this.props.badge_class);d=(React.createElement("span",{className:e,style:{marginLeft:5}},b));
}var c=null;if(this.props.tab_index==this.props.selected_tab){c="active";}return(React.createElement("li",{className:c},React.createElement("a",{href:location.hash,onClick:this.onClick,ref:"tab"},i18n(this.props.i18n_tab_name),d)));
}});a.NavTabDropDownAction=React.createClass({displayName:"NavTabDropDownAction",getInitialState:function(){return{active_dropdown_action_tab:false};
},hide:function(){document.removeEventListener("click",this.hide);this.setState({active_dropdown_action_tab:false});
},componentWillUnmount:function(){if(this.state.active_dropdown_action_tab){document.removeEventListener("click",this.hide);
}},onDropDownActionClick:function(b){b.preventDefault();$(React.findDOMNode(this.refs.tab)).blur();
if(this.state.active_dropdown_action_tab){document.removeEventListener("click",this.hide);
}else{document.addEventListener("click",this.hide);}this.setState({active_dropdown_action_tab:!this.state.active_dropdown_action_tab});
},onMenuClick_postponed:function(b){this.props.onActionTabClick("postponed",this.props.selected_status_tab);
},onMenuClick_cancel:function(b){this.props.onActionTabClick("cancel",this.props.selected_status_tab);
},onMenuClick_noexpiration:function(b){this.props.onActionTabClick("noexpiration",this.props.selected_status_tab);
},onMenuClick_delete:function(b){this.props.onActionTabClick("delete",this.props.selected_status_tab);
},onMenuClick_stop:function(b){this.props.onActionTabClick("stop",this.props.selected_status_tab);
},onMenuClick_setinwait:function(b){this.props.onActionTabClick("setinwait",this.props.selected_status_tab);
},render:function(){var b=this.props.selected_status_tab;var h=a.status[b].btns;var e=[];
for(var g in h){var d=h[g];var c=" "+i18n("manager.jobs.btn."+d);if(d=="postponed"){e.push(React.createElement("li",{key:d,onClick:this.onMenuClick_postponed}," ",React.createElement("a",{href:location.hash},React.createElement("i",{className:"icon-step-forward"}),c," ")));
}else{if(d=="cancel"){e.push(React.createElement("li",{key:d,onClick:this.onMenuClick_cancel},"  ",React.createElement("a",{href:location.hash},React.createElement("i",{className:"icon-off"}),c,"    ")));
}else{if(d=="noexpiration"){e.push(React.createElement("li",{key:d,onClick:this.onMenuClick_noexpiration},React.createElement("a",{href:location.hash},React.createElement("i",{className:"icon-calendar"}),c,"  ")));
}else{if(d=="delete"){e.push(React.createElement("li",{key:d,onClick:this.onMenuClick_delete},"  ",React.createElement("a",{href:location.hash},React.createElement("i",{className:"icon-trash"}),c,"   ")));
}else{if(d=="stop"){e.push(React.createElement("li",{key:d,onClick:this.onMenuClick_stop},"  ",React.createElement("a",{href:location.hash},React.createElement("i",{className:"icon-stop"}),c,"   ")));
}else{if(d=="setinwait"){e.push(React.createElement("li",{key:d,onClick:this.onMenuClick_setinwait}," ",React.createElement("a",{href:location.hash},React.createElement("i",{className:"icon-inbox"}),c,"   ")));
}}}}}}}if(e.length==0){return null;}var f=classNames("dropdown","pull-right",{open:this.state.active_dropdown_action_tab});
return(React.createElement("li",{key:"action",ref:"tab",className:f},React.createElement("a",{className:"dropdown-toggle",href:location.hash,onClick:this.onDropDownActionClick},i18n("manager.jobs.foreachbtntable")," ",React.createElement("b",{className:"caret"})),React.createElement("ul",{className:"dropdown-menu"},e)));
}});a.JobListCartridges=React.createClass({displayName:"JobListCartridges",getInitialState:function(){return{version:null};
},componentWillMount:function(){mydmam.async.request("broker","appversion",{},function(b){this.setState({version:b});
}.bind(this));},render:function(){var j=this.props.joblist;var h=this.props.selected_tab;
var i=false;var c=[];for(var f in this.props.joblist){var d=this.props.joblist[f];
if(a.status[d.status].tab!=h){continue;}c.push(d);if(c.length>49){i=true;break;}}if(h==a.status.WAITING.tab){c=c.sort(function(o,n){return o.create_date-n.create_date;
});}else{if(h==a.status.DONE.tab){c=c.sort(function(o,n){return o.end_date-n.end_date;
});}else{if(h==a.status.PROCESSING.tab){c=c.sort(function(o,n){return o.start_date-n.start_date;
});}else{c=c.sort(function(o,n){return n.update_date-o.update_date;});}}}var e=[];
for(var k in c){var d=c[k];var l=[];if(d.required_keys){for(var b in d.required_keys){var m=d.required_keys[b];
if(j[m]){l.push(j[m]);}else{l.push({key:m});}}}e.push(React.createElement(a.JobCartridge,{key:d.key,job:d,version:this.state.version,required_jobs:l,action_avaliable:this.props.action_avaliable,onActionButtonClick:this.props.onActionButtonClick}));
}var g=null;if(i){g=(React.createElement(mydmam.async.AlertBox,{title:i18n("manager.jobs.toomanyjobs")},i18n("manager.jobs.limitedjoblist",c.length)));
}return(React.createElement("div",null,g,e));}});a.displayKey=function(c,b){if(!c){return null;
}var d=c.substring(c.lastIndexOf(":")+1,c.lastIndexOf(":")+9)+".";if(b){return(React.createElement("abbr",{title:c},React.createElement("code",null,React.createElement("i",{className:"icon-barcode"})," ",d)));
}else{return d;}};a.JobProgression=React.createClass({displayName:"JobProgression",render:function(){var g=this.props.job;
var f=null;var b=null;var e=null;if(g.progression){var c="100%";if(g.progression.progress_size>0){c=((g.progression.progress*100)/g.progression.progress_size);
if(c>98){c="100%";}else{c=c+"%";}}var d=classNames("progress",{"progress-striped":g.status==="PREPARING"|g.status==="PROCESSING"|g.status==="STOPPED"|g.status==="TOO_LONG_DURATION"|g.status==="ERROR",active:g.status==="PROCESSING","progress-warning":g.status==="CANCELED","progress-danger":g.status==="STOPPED"|g.status==="TOO_LONG_DURATION"|g.status==="ERROR"|g.status==="TOO_OLD","progress-success":g.status==="DONE","progress-info":g.status==="WAITING"|g.status==="PREPARING"|g.status==="PROCESSING"|g.status==="POSTPONED"});
f=(React.createElement("div",{className:d,style:{height:"12px",marginBottom:0}},React.createElement("div",{className:"bar",style:{width:c}})));
if(g.progression.last_message){b=(React.createElement("em",null,React.createElement("i",{className:"icon-comment"})," ",g.progression.last_message));
}if(g.progression.step_count>0){e=(React.createElement("strong",null,g.progression.step,React.createElement("i",{className:"icon-arrow-right"}),g.progression.step_count));
}}return(React.createElement("span",null,React.createElement("div",null,React.createElement("div",{className:"pull-left",style:{marginRight:5,marginTop:-4}},e),React.createElement("div",null,f)),b));
}});a.JobCartridgeActionButtons=React.createClass({displayName:"JobCartridgeActionButtons",onClickButton_hipriority:function(b){b.stopPropagation();
this.props.onActionButtonClick("hipriority");},onClickButton_postponed:function(b){b.stopPropagation();
this.props.onActionButtonClick("postponed");},onClickButton_cancel:function(b){b.stopPropagation();
this.props.onActionButtonClick("cancel");},onClickButton_noexpiration:function(b){b.stopPropagation();
this.props.onActionButtonClick("noexpiration");},onClickButton_delete:function(b){b.stopPropagation();
this.props.onActionButtonClick("delete");},onClickButton_stop:function(b){b.stopPropagation();
this.props.onActionButtonClick("stop");},onClickButton_setinwait:function(b){b.stopPropagation();
this.props.onActionButtonClick("setinwait");},render:function(){var d=this.props.status;
var f=this.props.stacked;var c=a.status[d].btns;var h=[];for(var i in c){var b=c[i];
var j=null;var e=null;if(f){j=" "+i18n("manager.jobs.btn."+b);e={marginBottom:7};
}var g=classNames("btn","btn-mini",{"btn-block":f});if(b=="hipriority"){h.push(React.createElement("button",{key:b,className:g,style:e,onClick:this.onClickButton_hipriority}," ",React.createElement("i",{className:"icon-warning-sign"}),j));
}else{if(b=="postponed"){h.push(React.createElement("button",{key:b,className:g,style:e,onClick:this.onClickButton_postponed}," ",React.createElement("i",{className:"icon-step-forward"}),j));
}else{if(b=="cancel"){h.push(React.createElement("button",{key:b,className:g,style:e,onClick:this.onClickButton_cancel}," ",React.createElement("i",{className:"icon-off"}),j));
}else{if(b=="noexpiration"){h.push(React.createElement("button",{key:b,className:g,style:e,onClick:this.onClickButton_noexpiration}," ",React.createElement("i",{className:"icon-calendar"}),j));
}else{if(b=="delete"){h.push(React.createElement("button",{key:b,className:g,style:e,onClick:this.onClickButton_delete}," ",React.createElement("i",{className:"icon-trash"}),j));
}else{if(b=="stop"){h.push(React.createElement("button",{key:b,className:g,style:e,onClick:this.onClickButton_stop}," ",React.createElement("i",{className:"icon-stop"}),j));
}else{if(b=="setinwait"){h.push(React.createElement("button",{key:b,className:g,style:e,onClick:this.onClickButton_setinwait}," ",React.createElement("i",{className:"icon-inbox"}),j));
}}}}}}}}if(h.length==0){return(React.createElement("div",null));}else{if(h.length==1){if(f){return(React.createElement("div",{className:"pull-right span4"},h[0]));
}else{return(React.createElement("div",{className:"pull-right"},h[0]));}}}if(f){return(React.createElement("div",{className:"pull-right span4"},h));
}return(React.createElement("div",{className:"btn-toolbar pull-right"},React.createElement("div",{className:"btn-group"},h)));
}});a.JobCartridge=React.createClass({displayName:"JobCartridge",getInitialState:function(){return{stacked:false};
},onToogleCartridgeSize:function(b){b.preventDefault();this.setState({stacked:!this.state.stacked});
},onActionButtonClick:function(b){this.props.onActionButtonClick(this.props.job,b);
},onClickDoNothing:function(b){b.stopPropagation();},render:function(){var h=this.props.job;
var B=this.props.required_jobs;var l=null;var k=null;var t=null;var u=null;var s=null;
var c=null;if(this.state.stacked){if(B.length>0){var j=[];for(var g in B){if(B[g].status){var o=a.status[B[g].status];
var p=classNames("badge",o.badge_class);j.push(React.createElement("div",{key:g},React.createElement("i",{className:"icon-hand-right",style:{marginLeft:5}}),React.createElement("strong",{style:{marginLeft:8,marginRight:8}},B[g].name),React.createElement("span",{className:p,style:{marginRight:8}},i18n(o.i18n_tab_name)),a.displayKey(B[g].key,true)));
}else{j.push(React.createElement("div",{key:g},React.createElement("i",{className:"icon-trash",style:{marginLeft:5}}),React.createElement("strong",{style:{marginLeft:8,marginRight:8}},i18n("manager.jobs.deletedjob"))));
}}k=(React.createElement("div",{className:"well well-small"},React.createElement("i",{className:"icon-tasks"})," ",i18n("manager.jobs.require"),React.createElement("div",{style:{marginLeft:8}},j)));
}var v=null;if(h.max_execution_time<(1000*3600*24)){if(h.max_execution_time>(3600*1000)){v=(React.createElement("span",{className:"label"},i18n("manager.jobs.max_execution_time_hrs",Math.round((h.max_execution_time/(3600*1000))))));
}else{v=(React.createElement("span",{className:"label"},i18n("manager.jobs.max_execution_time_sec",(h.max_execution_time/1000))));
}}l=(React.createElement("div",null,React.createElement("div",{style:{marginTop:5}},React.createElement(mydmam.async.pathindex.reactDate,{i18nlabel:"manager.jobs.createdate",date:h.create_date,style:{marginLeft:0}})),React.createElement("div",{style:{marginTop:4}},React.createElement("span",{className:"label label-info"},React.createElement("i",{className:"icon-cog icon-white"})," ",i18n("manager.jobs.createdbysimple",h.instance_status_creator_key))),React.createElement("div",{style:{marginTop:4}},i18n("manager.jobs.classcreator")," ",React.createElement(mydmam.async.JavaClassNameLink,{javaclass:h.creator,version:this.props.version})),React.createElement("div",{style:{marginTop:4,marginBottom:8}},v)));
var n=[];if(h.start_date>0){n.push(React.createElement("div",{style:{marginTop:5},key:"sdate"},React.createElement(mydmam.async.pathindex.reactDate,{i18nlabel:"manager.jobs.start_date",date:h.start_date})));
if(h.end_date>0){n.push(React.createElement("div",{style:{marginTop:5},key:"edate"},React.createElement(mydmam.async.pathindex.reactDate,{i18nlabel:"manager.jobs.end_date",date:h.end_date})));
n.push(React.createElement("div",{style:{marginTop:5},key:"deltadate"},React.createElement("span",{className:"label",style:{marginLeft:5}},React.createElement("i",{className:"icon-time icon-white"})," ",i18n("manager.jobs.duration",Math.round((h.end_date-h.start_date)/1000)))));
n.push(React.createElement("div",{style:{marginTop:5},key:"sinceedate"},React.createElement(mydmam.async.pathindex.reactSinceDate,{i18nlabel:"manager.jobs.end_date_for",date:h.end_date})));
}}t=(React.createElement("div",null,n));u=(React.createElement(mydmam.async.JavaStackTrace,{processing_error:h.processing_error,version:this.props.version}));
var A=null;var f=JSON.stringify(h.context.content,null," ");if(f!="{}"){A=(React.createElement("code",{className:"json",onClick:this.onClickDoNothing},React.createElement("i",{className:"icon-indent-left"}),React.createElement("span",{className:"jsontitle"}," ",i18n("manager.jobs.context")),f));
}var b=null;if(h.context.neededstorages){var i="manager.jobs.targetstorage";if(h.context.neededstorages.length>1){i="manager.jobs.targetstorages";
}b=(React.createElement("span",null,i18n(i)," ",React.createElement("span",{className:"badge badge-warning"},React.createElement("i",{className:"icon-hdd icon-white"})," ",h.context.neededstorages.join(", "))));
}var w=null;if(h.context.hookednames){var i="manager.jobs.hookedname";if(h.context.hookednames.length>1){i="manager.jobs.hookednames";
}w=(React.createElement("span",null,i18n(i)," ",React.createElement("span",{className:"badge badge-inverse"},React.createElement("i",{className:"icon-tags icon-white"})," ",h.context.hookednames.join(", "))));
}c=(React.createElement("div",{style:{marginBottom:7}},React.createElement("div",{style:{marginTop:5}},i18n("manager.jobs.contextclass")," ",React.createElement(mydmam.async.JavaClassNameLink,{javaclass:h.context.classname,version:this.props.version})),React.createElement("div",{style:{marginTop:5}},b),React.createElement("div",{style:{marginTop:5}},w),React.createElement("div",{style:{marginTop:7}},A)));
var q=(React.createElement("div",{style:{marginTop:5}},i18n("manager.jobs.jref")," ",React.createElement("span",null,a.displayKey(h.key,true))));
if(h.worker_reference!=null&h.worker_class!=null){s=(React.createElement("div",{className:"span7"},React.createElement("div",{style:{marginTop:5}},i18n("manager.jobs.wref")," ",React.createElement("span",null,a.displayKey(h.worker_reference,true))),React.createElement("div",{style:{marginTop:5}},i18n("manager.jobs.classexec")," ",React.createElement(mydmam.async.JavaClassNameLink,{javaclass:h.worker_class,version:this.props.version})),q));
}else{s=(React.createElement("div",{className:"span7"},q));}}var e=null;if(h.delete_after_completed){e=(React.createElement("span",{className:"label label-inverse"},i18n("manager.jobs.delete_after_completed")));
}var y=null;if(h.priority>0){var z=null;if(h.urgent){z=(React.createElement("i",{className:"icon-warning-sign icon-white"}));
}y=(React.createElement("span",{className:"badge badge-important"},z," ",i18n("manager.jobs.priority",h.priority)));
}var d=null;if(h.status==="WAITING"|h.status==="TOO_OLD"){d=(React.createElement(mydmam.async.pathindex.reactDate,{i18nlabel:"expiration_date",date:h.expiration_date}));
}else{if(h.status==="PROCESSING"|h.status==="DONE"|h.status==="STOPPED"|h.status==="TOO_LONG_DURATION"|h.status==="CANCELED"|h.status==="POSTPONED"|h.status==="ERROR"){d=(React.createElement(a.JobProgression,{job:h}));
}}var r=null;if(h.instance_status_executor_key){if(this.state.stacked){r=(React.createElement("span",{className:"label label-info"},React.createElement("i",{className:"icon-cog icon-white"})," by ",h.instance_status_executor_key));
}else{r=(React.createElement("span",{className:"label label-info"},React.createElement("i",{className:"icon-cog icon-white"})," by ",h.instance_status_executor_key.substring(0,h.instance_status_executor_key.indexOf("#"))));
}}var m=classNames("row-fluid","hover-focus",{stacked:this.state.stacked});var x=null;
if(this.props.action_avaliable){x=(React.createElement(a.JobCartridgeActionButtons,{status:h.status,stacked:this.state.stacked,onActionButtonClick:this.onActionButtonClick}));
}return(React.createElement("div",{className:m,onClick:this.onToogleCartridgeSize},React.createElement("div",{className:"span3 nomargin"},React.createElement("strong",null,h.name),l,k),React.createElement("div",{className:"span3 nomargin"},React.createElement(mydmam.async.pathindex.reactSinceDate,{i18nlabel:"manager.jobs.update_date",date:h.update_date})," ",e," ",y,t),React.createElement("div",{className:"span3 nomargin"},d,c,u),React.createElement("div",{className:"span3 nomargin"},r,s,x)));
}});})(window.mydmam.async.broker);