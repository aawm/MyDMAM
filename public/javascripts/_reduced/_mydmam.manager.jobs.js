(function(a){a.view={};a.list={};a.last_refresh=null;a.last_full_refresh=null;a.jquery_destination="";
a.jquery_header="";a.datatable=null;a.refresh_intervaller=null;a.status_list=["TOO_OLD","CANCELED","POSTPONED","WAITING","DONE","PROCESSING","STOPPED","ERROR","PREPARING","TOO_LONG_DURATION"];
a.refresh_delay_time=5000;a.last_full_refresh_delay_time=300*1000;a.default_max_execution_time=1000*3600*24;
a.default_max_expiration_time=a.default_max_execution_time*7;a.grace_period_to_remove_deleted_after_completed_job=1000*30;
})(window.mydmam.manager.jobs);(function(a){a.drawTable=function(){var b="";b=b+'<table class="table table-striped table-bordered table-hover table-condensed" style="margin-bottom: 0px;">';
b=b+"<thead>";b=b+"<th>"+i18n("manager.jobs.th.name")+"</th>";b=b+"<th>"+i18n("manager.jobs.th.status")+"</th>";
b=b+"<th>"+i18n("manager.jobs.th.date")+"</th>";b=b+"<th>"+i18n("manager.jobs.th.params")+"</th>";
b=b+"<th>"+i18n("manager.jobs.th.progress")+"</th>";if(mydmam.manager.url.jobaction){b=b+"<th>"+i18n("manager.jobs.th.action")+"</th>";
}b=b+"</thead>";b=b+"<tbody>";b=b+"</tbody>";b=b+"</table>";var c=[{sWidth:"4em",aTargets:[1]},{sWidth:"5em",aTargets:[2]}];
if(mydmam.manager.url.jobaction){c.push({sWidth:"8em",aTargets:[5]});}$(a.jquery_destination).html(b);
a.datatable=$(a.jquery_destination+" table").dataTable({bPaginate:false,bLengthChange:false,bSort:true,bInfo:false,bAutoWidth:false,bFilter:true,aoColumnDefs:c});
$(a.jquery_destination+" table td.dataTables_empty").html("<em>"+i18n("manager.jobs.tableisempty")+"</em>");
};})(window.mydmam.manager.jobs);(function(a,b){a.addRow=function(d,g){if(d.isThisStatus(g)===false){return;
}var k=[];var i="";var e="jobkey-"+d.key.substring(6,16);i=i+b.getNameCol(d);i=i+'<button class="btn btn-mini pull-right btnshowcollapse '+e+'"><i class="icon-chevron-down"></i></button>';
k.push(i);k.push(b.getStatusCol(d));k.push(b.getDateCol(d));k.push(b.getParamCol(d));
k.push(b.getProgressionCol(d));if(mydmam.manager.url.jobaction){k.push(b.getButtonsCol(d));
}var f=a.datatable;var c=f.fnAddData(k)[0];var j=f.$("button.btnshowcollapse."+e);
j.removeClass(e);d.web={datatablerowpos:c,jqueryrow:j.parent().parent(),status:d.status};
j.click(function(){d.web.jqueryrow.find("div.collapse").addClass("in");$(this).remove();
});if(mydmam.manager.url.jobaction){var h=d.web.jqueryrow.find("button.btnjobaction");
h.click(function(){var n=$(this);var l=n.data("target-order");var m=n.data("target-key");
var o={order:l,jobs_keys:[m]};a.doAction(o,h);});}};})(window.mydmam.manager.jobs,window.mydmam.manager.jobs.view);
(function(a){a.doAction=function(c,b){$.ajax({url:mydmam.manager.url.jobaction,type:"POST",data:{requestactions:JSON.stringify(c)},beforeSend:function(){b.addClass("disabled");
},error:function(d,f,e){$(a.jquery_destination+" div.alert").remove();$(a.jquery_destination).prepend('<div class="alert"><strong>'+i18n("error")+"</strong></div>");
},success:function(d){if(d[0]){$(a.jquery_destination+" div.alert").remove();$(a.jquery_destination).prepend('<div class="alert"><strong>'+i18n("error")+"</strong></div>");
return;}if(c.order==="delete"){for(var g=0;g<c.jobs_keys.length;g++){var f=c.jobs_keys[g];
var e=a.list[f];if(e){a.deleteRow(e);delete a.list[f];}}}b.removeClass("disabled");
a.ajaxRefreshOnsuccess(d,false);}});};})(window.mydmam.manager.jobs,window.mydmam.manager.jobs.view);
(function(a){a.deleteRow=function(e){var d=e.web.datatablerowpos;for(var c in a.list){var b=a.list[c];
if(!b.web){continue;}if(d<b.web.datatablerowpos){b.web.datatablerowpos--;}}a.datatable.fnDeleteRow(d);
e.web=null;$(a.jquery_destination+" table td.dataTables_empty").html("<em>"+i18n("manager.jobs.tableisempty")+"</em>");
};})(window.mydmam.manager.jobs);(function(a,b){a.updateRow=function(d,c){if(d.isThisStatus(c)===false){if(d.web){a.deleteRow(d);
}return;}if(d.web==null){a.addRow(d,c);}b.update(d);};})(window.mydmam.manager.jobs,window.mydmam.manager.jobs.view);
(function(a){a.hideTable=function(){$(a.jquery_destination+" table").remove();$(a.jquery_header+" ul").remove();
};})(window.mydmam.manager.jobs);(function(a){a.refreshHeaderCounters=function(){var d={};
for(var e=0;e<a.status_list.length;e++){d[a.status_list[e]]=0;}for(var b in a.list){d[a.list[b].status]++;
}var c=function(){var g=0;for(var f in d){if($(this).hasClass("jobswitch"+f)){g+=d[f];
}}if(g>0){$(this).children("span.badge").html(g);}else{$(this).children("span.badge").html("");
}};$(a.jquery_header+" ul.nav.joblistheader a.btnswitchjoblisttable").each(c);};})(window.mydmam.manager.jobs);
(function(a){a.getSelectedStatusHeaderTab=function(){var d=$(a.jquery_header+" ul.nav.joblistheader li.active").children("a");
var b=[];for(var e=0;e<a.status_list.length;e++){var c=a.status_list[e];if(d.hasClass("jobswitch"+c)){b.push(c);
}}return b;};})(window.mydmam.manager.jobs);(function(a){a.drawHeader=function(e){var c=0;
if(e){var b=e[0];if(b==="PREPARING"){c=1;}else{if(b==="PROCESSING"){c=1;}else{if(b==="DONE"){c=2;
}else{if(b==="TOO_OLD"){c=3;}else{if(b==="STOPPED"){c=4;}else{if(b==="TOO_LONG_DURATION"){c=4;
}else{if(b==="CANCELED"){c=5;}else{if(b==="POSTPONED"){c=5;}else{if(b==="ERROR"){c=6;
}}}}}}}}}}var d="";d=d+'<ul class="nav nav-tabs joblistheader">';d=d+'<li><a href="" data-toggle="tab" class="btnswitchjoblisttable jobswitchWAITING">';
d=d+i18n("manager.jobs.status.WAITING")+' <span class="badge" style="margin-left: 5px;"></span>';
d=d+"</a></li>";d=d+'<li><a href="" data-toggle="tab" class="btnswitchjoblisttable jobswitchPREPARING jobswitchPROCESSING">';
d=d+i18n("manager.jobs.status.PREPARINGPROCESSING")+' <span class="badge badge-warning" style="margin-left: 5px;"></span>';
d=d+"</a></li>";d=d+'<li><a href="" data-toggle="tab" class="btnswitchjoblisttable jobswitchDONE">';
d=d+i18n("manager.jobs.status.DONE")+' <span class="badge badge-success" style="margin-left: 5px;"></span>';
d=d+"</a></li>";d=d+'<li><a href="" data-toggle="tab" class="btnswitchjoblisttable jobswitchTOO_OLD">';
d=d+i18n("manager.jobs.status.TOO_OLD")+' <span class="badge badge-info" style="margin-left: 5px;"></span>';
d=d+"</a></li>";d=d+'<li><a href="" data-toggle="tab" class="btnswitchjoblisttable jobswitchSTOPPED jobswitchTOO_LONG_DURATION">';
d=d+i18n("manager.jobs.status.STOPPEDTOO_LONG_DURATION")+' <span class="badge badge-info" style="margin-left: 5px;"></span>';
d=d+"</a></li>";d=d+'<li><a href="" data-toggle="tab" class="btnswitchjoblisttable jobswitchCANCELED jobswitchPOSTPONED">';
d=d+i18n("manager.jobs.status.CANCELEDPOSTPONED")+' <span class="badge" style="margin-left: 5px;"></span>';
d=d+"</a></li>";d=d+'<li><a href="" data-toggle="tab" class="btnswitchjoblisttable jobswitchERROR">';
d=d+i18n("manager.jobs.status.ERROR")+' <span class="badge badge-important" style="margin-left: 5px;"></span>';
d=d+"</a></li>";d=d+"</ul>";$(a.jquery_header).html(d);$(a.jquery_header+" ul.nav.joblistheader a.btnswitchjoblisttable").click(function(){$(this).blur();
$(a.jquery_header+" ul.nav.joblistheader li").removeClass("active");$(this).parent().addClass("active");
a.drawTable();a.refreshHeaderCounters();var g=a.getSelectedStatusHeaderTab();for(var f in a.list){a.addRow(a.list[f],g);
}return false;});$(a.jquery_header+" ul.nav.joblistheader a.btnswitchjoblisttable:eq("+c+")").click();
};})(window.mydmam.manager.jobs);(function(a){a.prepare=function(e){$(e).addClass("pull-right");
$(e).css("display","inline");$(e).append('<button id="btnjobslistrefresh" class="btn btn-mini pull-right"><i class="icon-refresh"></i></button>');
$(e).append('<img id="imgajaxloaderjobslistrefresh" class="pull-right" style="display: none; margin-right: 10px; margin-top: 3px;" src="'+mydmam.urlimgs.ajaxloader+'" />');
var c=function(){a.ajaxRefresh(true);};var d=function(){a.ajaxRefresh(false);};$("#btnjobslistrefresh").click(c);
a.refresh_intervaller=setInterval(d,a.refresh_delay_time);var b=a.list;a.list={};
a.ajaxRefreshOnsuccess(b,true);};})(window.mydmam.manager.jobs);(function(a){a.switchHourglassRefresh=function(b){if(b){$("#imgajaxloaderjobslistrefresh").css("display","inline");
$("#btnjobslistrefresh").css("display","none");}else{$("#imgajaxloaderjobslistrefresh").css("display","none");
$("#btnjobslistrefresh").css("display","inline");}};})(window.mydmam.manager.jobs);
(function(a){a.ajaxRefreshOnsuccess=function(e,d){a.switchHourglassRefresh(false);
if(d){$(a.jquery_destination+" div.alert").remove();}a.last_refresh=new Date().getTime();
if(d){a.last_full_refresh=a.last_refresh;}if((e==null)|e.length===0){if(d){$(a.jquery_destination).prepend('<div class="alert alert-info"><strong>'+i18n("empty")+"</strong></div>");
a.hideTable();a.list={};}else{return;}}else{for(var h in e){e[h].isThisStatus=function(i){if(Array.isArray(i)){return i.indexOf(this.status)>-1;
}else{return i===this.status;}};}var g=a.getSelectedStatusHeaderTab();if(d){a.list=e;
a.drawHeader(g);}else{for(var f in e){var b=a.list[f];var c=e[f];if(b){if(b.web){c.web=b.web;
}a.updateRow(c,g);}else{a.addRow(c,g);}a.list[f]=c;}a.refreshHeaderCounters();}}};
})(window.mydmam.manager.jobs);(function(a){a.ajaxRefresh=function(d){var e=null;
var f=null;var c=d;if(a.last_refresh===0){c=true;}if(a.last_full_refresh+a.last_full_refresh_delay_time<(new Date().getTime())){c=true;
}if(c){e=mydmam.manager.url.alljobs;f=null;}else{e=mydmam.manager.url.recentupdatedjobs;
f={since:a.last_refresh};}var b=function(g,i,h){a.switchHourglassRefresh(false);$(a.jquery_destination+" div.alert").remove();
$(a.jquery_destination).prepend('<div class="alert"><strong>'+i18n("error")+"</strong></div>");
a.last_refresh=0;a.list={};a.hideTable();};$.ajax({url:e,type:"POST",data:f,beforeSend:function(){a.switchHourglassRefresh(true);
},error:b,success:function(g){a.ajaxRefreshOnsuccess(g,c);}});};})(window.mydmam.manager.jobs);
