<?xml version="1.0"?>
<project name="MyDMAM" default="build">
	<description>MyDMAM: Another way of looking a Digital Media Asset
		Management</description>

	<property environment="env" />

	<property name="mydmam.app" location="app" />
	<property name="mydmam.lib" location="lib" />

	<target name="prepare" description="Prepare output directories">
		<property name="out.dir" location="build" />
		<property name="out.bin" location="${out.dir}/bin" />
		<property name="out.lib" location="${out.dir}/lib" />
		<property name="out.src" location="${out.dir}/src" />
		
		<delete dir="${out.dir}" />
		<mkdir dir="${out.dir}" />
		<mkdir dir="${out.bin}" />
		<mkdir dir="${out.lib}" />
	</target>

	<target name="getgitversion" depends="prepare" description="Get git last commit hash">
		<exec executable="git" outputproperty="gitversion">
			<arg value="describe" />
		</exec>
		<echo>Git version: ${gitversion}</echo>
	</target>

	<target name="checklocaljardependencies" depends="prepare" description="Test the needs to download all Play and MyDMAM dependencies or not">
		<!-- If there are some jars in lib directory -->
		<fileset dir="${mydmam.lib}" id="myfileset" includes="*.jar" />
		<pathconvert refid="myfileset" property="fileset.notempty" setonempty="false" />
		<condition property="needstodownloadjardependencies">
			<not>
				<length string="${fileset.notempty}" trim="true" length="50" when="greater" />
			</not>
		</condition>
		<condition property="notneedstodownloadjardependencies">
			<length string="${fileset.notempty}" trim="true" length="50" when="greater" />
		</condition>
	</target>

	<target name="downloadjardependencies" depends="checklocaljardependencies" description="Get all Play and MyDMAM dependencies from MyDMAM website to the build dir" if="needstodownloadjardependencies">
		<mkdir dir="${out.lib}" />
		<get src="http://mydmam.org/dwl/lib/" dest="${out.lib}/dependencies.xml" />
		<ant antfile="${out.lib}/dependencies.xml" />
		<delete file="${out.lib}/dependencies.xml" />
		<checksum verifyProperty="isMD5ok">
			<fileset dir="${out.lib}">
				<include name="*.jar" />
			</fileset>
		</checksum>
		<fail message="Invalid checksum for dependencies downloaded jar files.">
			<condition>
				<isfalse value="${isMD5ok}" />
			</condition>
		</fail>
		<delete>
			<fileset dir="${out.lib}" includes="*.jar.MD5" />
		</delete>

	</target>

	<target name="copylocaljardependencies" depends="checklocaljardependencies" description="Copy MyDMAM dependencies to the build dir" if="notneedstodownloadjardependencies">
		<copy todir="${out.lib}" flatten="true">
			<fileset dir="${mydmam.lib}">
				<include name="*.jar" />
			</fileset>
		</copy>
	</target>

	<target name="compile" depends="downloadjardependencies, copylocaljardependencies" description="Invoke javac for make classes">
		
		<!-- Create classpath with all MyDMAM dependencies -->
		<path id="mydmam.classpath">
			<fileset dir="${out.lib}">
				<include name="*.jar" />
			</fileset>
		</path>
		
		<javac srcdir="${mydmam.app}" destdir="${out.bin}" excludes="models react views **/*Test.java" includeantruntime="false" target="1.8">
			<classpath refid="mydmam.classpath" />
			<compilerarg value="-XDignore.symbol.file" />
		</javac>
	</target>

	<target name="makelib" depends="compile, getgitversion" description="Create MyDMAM bin jar">
		<jar basedir="${out.bin}" destfile="${out.lib}/mydmam-${gitversion}-bin.jar">
			<manifest>
				<attribute name="Main-Class" value="hd3gtv.mydmam.MainClass" />
				<attribute name="Codebase" value="mydmam.org" />
				<attribute name="Built-By" value="hdsdi3g" />
				<attribute name="Implementation-Vendor" value="MyDMAM" />
				<attribute name="Implementation-Title" value="MyDMAM" />
				<attribute name="Implementation-Version" value="${gitversion}" />
			</manifest>
		</jar>
		<delete dir="${out.bin}" />
	</target>

	<target name="copyproject" depends="prepare" description="Copy all mandatory Play projet items">
		<mkdir dir="${out.dir}/app" />
		<mkdir dir="${out.dir}/app/controllers" />
		<mkdir dir="${out.dir}/app/models" />
		<mkdir dir="${out.dir}/app/views" />
		<copy todir="${out.dir}/app/views">
			<fileset dir="app/views">
			</fileset>
		</copy>

		<mkdir dir="${out.dir}/conf" />
		<copy todir="${out.dir}/conf">
			<fileset dir="conf">
				<exclude name="app.d/" />
				<exclude name="application.conf" />
				<exclude name="build.properties" />
				<exclude name="*.db" />
				<exclude name="dependencies.yml" />
				<exclude name="log4j.xml" />
				<exclude name="ssh/" />
				<exclude name="jsfiles.json" />
			</fileset>
		</copy>
		<copy file="LICENSE" todir="${out.dir}" />
		<copy file="UPGRADE.txt" todir="${out.dir}" />

		<mkdir dir="${out.dir}/modules" />
		<mkdir dir="${out.dir}/test" />

		<copy todir="${out.dir}/public">
			<fileset dir="public">
				<exclude name="javascripts/src/" />
				<exclude name="javascripts/_transformed/" />
				<exclude name="javascripts/_reduced/*.js" />
			</fileset>
		</copy>
	</target>

	<target name="makesource" depends="prepare, getgitversion" description="Create MyDMAM source jar">
		<mkdir dir="${out.src}" />
		<jar basedir="${mydmam.app}" destfile="${out.src}/mydmam-${gitversion}-src.jar"
			excludes="**/*Test.java">
		</jar>
	</target>

	<!-- Starts with like
		ant -Dplay="/opt/play" copyplayjars
	TODO add to doc --> 
	<target name="copyplayjars" description="Copy Play dependencies to the current lib dir (autonomous task)">
		<copy todir="${mydmam.lib}" flatten="true">
			<fileset dir="${play}/framework/lib">
				<include name="*.jar" />
			</fileset>
			<fileset dir="${play}/framework">
				<include name="*.jar" />
			</fileset>
			<fileset dir="${play}/modules/docviewer/lib/">
				<include name="*.jar" />
			</fileset>
		</copy>
	</target>

	<target name="build" depends="makelib, makesource, copyproject" description="Prepare dependencies, compile, create jars, and prepare clean project">
	</target>

	<!-- TODO add doc: it needs JDK ! -->
	<!-- TODO add bootstrap scripts -->
	<!-- TODO add startup scripts -->

</project>
