<?xml version="1.0" encoding="UTF-8"?>
<project name="MyDMAM ant tools" default="nope">

	<target name="nope" description="Warn for remind to not use this file">
		<echo>Don't use this ANT build file directly</echo>
	</target>

	<condition property="is_windows"><os family="windows"/></condition>
	<condition property="is_linux"><os family="unix"/></condition>
	<condition property="is_mac"><os family="mac"/></condition>

	<target name="prepare" description="Prepare output directories">
		<property name="out.bin" location="${out.dir}/bin" />
		<property name="out.lib" location="${out.dir}/lib" />
		<property name="out.src" location="${out.dir}/src" />
		<property name="out.jre" location="${out.dir}/jre" />
		<property name="out.conf" location="${out.dir}/conf" />
		
		<delete dir="${out.dir}" />
		<mkdir dir="${out.dir}" />
		<mkdir dir="${out.bin}" />
		<mkdir dir="${out.lib}" />
		<mkdir dir="${out.jre}" />
		<mkdir dir="${out.conf}" />
		
		<property name="out.jre.windows" location="${out.jre}/${archive.jre.extractedbasename.windows}" />
		<property name="out.jre.linux" location="${out.jre}/${archive.jre.extractedbasename.linux}" />
		<property name="out.jre.mac" location="${out.jre}/${archive.jre.extractedbasename.mac}" />
	</target>
	
	<target name="getgitversion" depends="prepare" description="Get git last commit hash">
		<exec executable="git" outputproperty="gitversion">
			<arg value="describe" />
	           <arg value="--always" />
		</exec>
		<echo>Git version: ${gitversion}</echo>
	</target>
	
	<target name="checklocaljardependencies" depends="prepare" description="Test the needs to download all Play and MyDMAM dependencies or not">
		<!-- If there are some jars in lib directory -->
		<fileset dir="${mydmam.lib}" id="myfileset" includes="*.jar" />
		<pathconvert refid="myfileset" property="fileset.notempty" setonempty="false" />
		<condition property="needstodownloadjardependencies">
			<not>
				<length string="${fileset.notempty}" trim="true" length="50" when="greater" />
			</not>
		</condition>
		<condition property="notneedstodownloadjardependencies">
			<length string="${fileset.notempty}" trim="true" length="50" when="greater" />
		</condition>
	</target>
	
	<target name="downloadjardependencies" depends="checklocaljardependencies" description="Get all Play and MyDMAM dependencies from MyDMAM website to the build dir" if="needstodownloadjardependencies">
		<mkdir dir="${out.lib}" />
		<get src="${mydmam.websiteurldownload}/lib/" dest="${out.lib}/dependencies.xml" />
		<ant antfile="${out.lib}/dependencies.xml" />
		<delete file="${out.lib}/dependencies.xml" />
		<checksum verifyProperty="isMD5ok">
			<fileset dir="${out.lib}">
				<include name="*.jar" />
			</fileset>
		</checksum>
		<fail message="Invalid checksum for dependencies downloaded jar files.">
			<condition>
				<isfalse value="${isMD5ok}" />
			</condition>
		</fail>
		<delete>
			<fileset dir="${out.lib}" includes="*.jar.MD5" />
		</delete>
	</target>

	<target name="copylocaljardependencies" depends="checklocaljardependencies" description="Copy MyDMAM dependencies to the build dir" if="notneedstodownloadjardependencies">
		<copy todir="${out.lib}" flatten="true">
			<fileset dir="${mydmam.lib}">
				<include name="*.jar" />
			</fileset>
		</copy>
	</target>

	<target name="makestarters" description="Prepare Windows/OSX/Linux starters">
		<echo file="${mydmam.startup}/setup.ini" append="false" force="true">; MyDMAM autogenerated file
working.directory=..\
classpath.1=..\conf
classpath.2=..\lib\*.jar
vm.location=.${basedir.jrebin.windows}\server\jvm.dll
vmarg.1=-Dfile.encoding=UTF-8
</echo>
		<echo file="${mydmam.startup}/setup.bash" append="false" force="true"># MyDMAM autogenerated file
JAVA_LINUX=.${basedir.jrebin.linux}/java
JAVA_OSX=.${basedir.jrebin.mac}/java
</echo>
	</target>

	<target name="exportpackforpublish" description="Make a manifest in an INI file for MyDmam website">
		<script language="javascript">
			<![CDATA[
				property = project.setProperty("now", Math.floor((new Date()).getTime()));
			]]>
		</script>
		<echo file="pack/pack-manifest.ini" append="false" force="true">; MyDMAM autogenerated file
[mydmam-pack-manifest]
jvm = ${archive.jre.extractedbasename}
version = ${gitversion}
now = ${now}
archive_windows = ${out.dir.archive.windows}
hash_windows = ${out.dir.archive.windows.hash}
archive_mac = ${out.dir.archive.mac}
hash_mac = ${out.dir.archive.mac.hash}
archive_linux = ${out.dir.archive.linux}
hash_linux = ${out.dir.archive.linux.hash}
; see http://php.net/manual/fr/function.parse-ini-file.php
</echo>
		<fixcrlf srcdir="pack" includes="pack-manifest.ini" eol="unix" />
	</target>

</project>