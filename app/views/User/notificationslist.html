*{
 * This file is part of MyDMAM.
 * 
 * This program is free software; you can redistribute it and/or modify
 * it under the terms of the GNU Lesser General Public License as published by
 * the Free Software Foundation; either version 3 of the License, or
 * any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU Lesser General Public License for more details.
 * 
 * Copyright (C) hdsdi3g for hd3g.tv 2014
 * 
}*
#{extends 'maingrid.html' /}

#{if flash.success}
    <div class="alert alert-info">
    	<button type="button" class="close" data-dismiss="alert">&times;</button>
	    ${flash.success}
    </div>
#{/if}
#{if flash.error || error}
	<div class="alert alert-error">
		<button type="button" class="close" data-dismiss="alert">&times;</button>
		${error ?: flash.error}
	</div>
#{/if}

<div id="errorplaceholder"></div>

<div class="container">

	<p class="lead">&{'userprofile.notifications.pagename'}</p>
	
%{ user_notifications.eachWithIndex() { notification, pos -> }%
<div class="" style="margin-bottom:0.5em;">
	<div class="">
		<button class="btn btn-mini #{if notification.is_read == false}btnsetreadnotification#{/if}" data-target="#notificationcontent${pos}" data-toggle="collapse" data-notificationkey="${notification.key}">
			<i class="icon-chevron-down"></i>
		</button>
		<span class="label label-info">&{notification.summary_status}</span>
		${notification.creating_comment}
	</div>
	<div class="collapse #{if flash.lastkey == notification.key}in#{/if}" id="notificationcontent${pos}">
		<div class="tabbable tabs-right" style="margin-top: 1em; margin-bottom: 1em;">
			<ul class="nav nav-tabs">
				<li class="active">
					<a data-toggle="tab" href="#tabpane${pos}main">Summary</a>
				</li>
				<li>
					<a data-toggle="tab" href="#tabpane${pos}tj">Tasks/Jobs</a>
				</li>
			</ul>
			<div class="tab-content">	
				<div id="tabpane${pos}main" class="tab-pane active">
					<div class="row-fluid">
						<div class="span4">
							<p>
								Created by <span class="userprofilekey">${notification.creator.encrypt()}</span>
							</p>
							<p>
								<span class="label">Created at ${notification.created_at.formatDate()}</span>
							</p>
							#{if notification.is_read}
								<p>
									<span class="label">Read at ${notification.readed_at.formatDate()}</span>
								</p>
								<p>
									Read by <span class="userprofilekey">${notification.first_reader.encrypt()}</span>
								</p>
							#{/if}#{else}
								#{if notification.is_close}
									<p>
										<span class="label">Close at ${notification.closed_at.formatDate()}</span>
									</p>
									<p>
										Close by <span class="userprofilekey">${notification.closed_by.encrypt()}</span>
									</p>
								#{/if}#{else}
									<p>
										<span class="label label-warning">Read <i>Now</i></span>
									</p>
									<p>
										Read by <span class="userprofilekey">${user.key.encrypt()}</span>
									</p>
								#{/else}
							#{/else}
							<p>
								<a class="btn btn-primary" href="@{User.notificationclose(key=notification.key)}">
									<i class="icon-ok icon-white"></i> Close
								</a>
							</p>
						</div> <!-- span4 -->
						<div class="span4">
							<p>
								#{if notification.commented_at > 0}
									<span class="label">Commented: ${notification.commented_at.formatDate()}</span>
								#{/if}#{else}
									<span class="label"><i>Never commented</i></span>
								#{/else}
							</p>
							#{form action:@User.notificationupdatecomment(key=notification.key), enctype:'multipart/form-data'}
								<p>
									<textarea name="comment" class="span12" placeholder="You can enter some comments here...">${notification.users_comment}</textarea>
								</p>
								<p>
									<button type="submit" class="btn btn-info"><i class="icon-edit icon-white"></i> Update comment</button>
								</p>
							#{/form}
						</div> <!-- span4 -->
						<div class="span4">
							Mail notification alerts:
							%{ notification.notify_list.eachWithIndex() { n_reason, tpos -> }% #{if n_reason.key != "notify_if_readed"}
								<p>								
									<a 
										class="btn btn-mini #{if n_reason.value}btn-success#{/if}#{else}btn-danger#{/else}"
										href="@{User.notificationupdatealert(key=notification.key, reason=n_reason.key, notify=(n_reason.value==false))}"
										title=" #{if n_reason.value}&{'userprofile.notifications.notify.disable'}#{/if}#{else}&{'userprofile.notifications.notify.enable'}#{/else}">
									#{if n_reason.value}
										<i class="icon-volume-off icon-white"></i>
									#{/if}#{else}
										<i class="icon-bell icon-white"></i>
									#{/else}
									</a>
									#{if n_reason.value}
										<span class="badge badge-important">&{'userprofile.notifications.' + n_reason.key, 'userprofile.notifications.notify.enabled'}</span>
									#{/if}#{else}
										<span class="badge">&{'userprofile.notifications.' + n_reason.key, 'userprofile.notifications.notify.disabled'}</span>
									#{/else}
								</p>								
							#{/if} %{ } }%
						</div> <!-- span4 -->
					</div> <!-- row-fluid -->
				</div> <!-- tab-pane -->
				<div id="tabpane${pos}tj" class="tab-pane">
					<div class="row-fluid">
						%{ notification.linked_tasks.eachWithIndex() { taskjob, tpos -> }%
							<div class="taskjobsummary">${taskjob.taskjobkey}</div>
						%{ } }%
					</div> <!-- row-fluid -->
				</div> <!-- tab-pane -->
			</div> <!-- tab-content -->
		</div> <!-- tabbable tabs-right -->
	</div>
</div>
%{ } }%

%{ if (user_notifications.isEmpty()) { }%
	<div class="alert alert-info" style="margin-bottom: 0px;">
		&{'userprofile.notifications.emptylist'}
	</div>
%{ } }%
</div>

<script type="text/javascript" charset="UTF-8">
<!--
var url_notificationupdateread = "@{User.notificationupdateread(key='keyparam1')}";

$(document).ready(function() {
   	try {
		$("#btnSession").addClass("active");
		mydmam.notification.postProcessPage();
		
		$(".userprofilekey").each(function() {
			var key = $(this).text();
			$(this).html("<a href=\"#\"> " + key + "</a>");
			//ASYNC console.log("TODO resolve User: " + key);
		});
		$(".taskjobsummary").each(function() {
			var key = $(this).text();
			$(this).html('<span class="label label-inverse">' + key + '</span>');
			//ASYNC console.log("TODO resolve Task/job: " + key);
		});
	} catch(err) {
		console.log(err);
	}
});
-->
</script>
